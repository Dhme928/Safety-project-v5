<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet"/>
  <link href="img/CAT.jpeg" rel="icon" type="image/jpeg"/>
  <title>Safety Observer Pro</title>
  <link href="css/styles.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="light-mode">
  <div class="app-container">
    <header class="app-header">
      <div class="header-title-area">
        <img alt="CAT Logo" class="header-logo" src="img/CAT.jpeg"/>
        <div class="header-text">
          <h1>Safety Observer Pro</h1>
          <p class="header-subtitle">Saudi Safety Group - CAT Project</p>
        </div>
      </div>
      <div class="header-actions">
        <div class="points-display" id="pointsDisplay" style="display:none;">
          <i class="fas fa-star"></i>
          <span id="userPoints">0</span>
        </div>
        <div class="header-badge" id="headerBadge" style="display:none;" title="Your Badge">
          <i class="fas fa-medal"></i>
        </div>
        <button class="news-toggle" id="newsToggleButton" type="button" title="News">
          <i class="fas fa-bullhorn"></i>
        </button>
      </div>
    </header>

    <div class="modal" id="loginModal">
      <div class="modal-content auth-modal">
        <h2><i class="fas fa-hard-hat"></i> Welcome</h2>
        <div id="authTabs" class="auth-tabs">
          <button class="auth-tab active" data-tab="login">Login</button>
          <button class="auth-tab" data-tab="register">Register</button>
        </div>
        <form id="loginForm" class="auth-form">
          <input type="text" id="loginEmployeeId" placeholder="Employee ID" required/>
          <input type="password" id="loginPassword" placeholder="Password" required/>
          <button type="submit" class="auth-submit-btn">Login</button>
          <p class="auth-error" id="loginError"></p>
        </form>
        <form id="registerForm" class="auth-form" style="display:none;">
          <input type="text" id="regEmployeeId" placeholder="Employee ID" required/>
          <input type="text" id="regName" placeholder="Full Name" required/>
          <input type="password" id="regPassword" placeholder="Password" required/>
          <button type="submit" class="auth-submit-btn">Register</button>
          <p class="auth-error" id="registerError"></p>
        </form>
      </div>
    </div>

    <div class="modal" id="newsModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('newsModal')">×</button>
        <h2><i class="fas fa-bullhorn"></i> News & Announcements</h2>
        <div id="newsContainer">Loading...</div>
      </div>
    </div>

    <div class="modal" id="leaderboardModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('leaderboardModal')">×</button>
        <h2><i class="fas fa-trophy"></i> Monthly Leaderboard</h2>
        <div id="leaderboardContainer">Loading...</div>
      </div>
    </div>

    <div class="modal" id="emergencyContactsModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('emergencyContactsModal')">×</button>
        <h2><i class="fas fa-ambulance"></i> Emergency Contacts</h2>
        <h3>Internal</h3>
        <div class="table-scroll">
          <table class="emergency-table">
            <thead><tr><th>Name</th><th>Designation</th><th>Contact</th></tr></thead>
            <tbody>
              <tr><td>CAT EMERGENCY</td><td>Emergency Line</td><td><a href="tel:0543133645">054 313 3645</a></td></tr>
              <tr><td>HARADH CLINIC</td><td>Clinic</td><td><a href="tel:0569180911">056 918 0911</a></td></tr>
              <tr><td>Maher A. Jardali</td><td>Operation Manager</td><td><a href="tel:0505817134">050 581 7134</a></td></tr>
              <tr><td>Rifat Mehmood</td><td>Project Manager</td><td><a href="tel:0505366873">050 536 6873</a></td></tr>
              <tr><td>Shahzad Ahmad Khan</td><td>HSSE Manager</td><td><a href="tel:0543133645">054 313 3645</a></td></tr>
              <tr><td>Mahmoud Al Cheikh</td><td>Project Engineer</td><td><a href="tel:0551367496">055 136 7496</a></td></tr>
              <tr><td>Om Prakash</td><td>HSSE Coordinator</td><td><a href="tel:0544303677">054 430 3677</a></td></tr>
              <tr><td>Hasan Almarzooq</td><td>HSSE Supervisor</td><td><a href="tel:0592399222">059 239 9222</a></td></tr>
              <tr><td>Dr. Shoiab</td><td>CAT Doctor</td><td><a href="tel:0537934638">053 793 4638</a></td></tr>
              <tr><td>Arif Khan</td><td>Safety Officer/First Aider</td><td><a href="tel:0576563119">057 656 3119</a></td></tr>
            </tbody>
          </table>
        </div>
        <h3 style="margin-top:1.5rem;">External</h3>
        <div class="table-scroll">
          <table class="emergency-table">
            <thead><tr><th>Service</th><th>Number</th></tr></thead>
            <tbody>
              <tr><td>Civil Defense (Fire)</td><td><a href="tel:998">998</a></td></tr>
              <tr><td>Red Crescent (Ambulance)</td><td><a href="tel:997">997</a></td></tr>
              <tr><td>Local Police</td><td><a href="tel:999">999</a></td></tr>
              <tr><td>Traffic Accidents</td><td><a href="tel:993">993</a></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal" id="addObservationModal">
      <div class="modal-content form-modal">
        <button class="close-btn" onclick="closeModal('addObservationModal')">×</button>
        <h2><i class="fas fa-eye"></i> Add Observation</h2>
        <form id="addObservationForm">
          <div class="form-row">
            <input type="date" id="obsDate" required/>
            <input type="time" id="obsTime"/>
          </div>
          <div class="form-group">
            <label>Area</label>
            <div class="area-select-wrapper">
              <select id="obsAreaSelect" required>
                <option value="">-- Select Area --</option>
              </select>
              <button type="button" class="add-new-btn" onclick="showAddAreaInput()"><i class="fas fa-plus"></i></button>
            </div>
            <div id="addAreaInput" class="add-new-input" style="display:none;">
              <input type="text" id="newAreaName" placeholder="New area name"/>
              <button type="button" class="btn-add-area" onclick="addNewArea()">Add</button>
              <button type="button" class="btn-cancel-area" onclick="hideAddAreaInput()">Cancel</button>
            </div>
          </div>
          <input type="text" id="obsLocation" placeholder="Specific Location"/>
          <div class="observation-class-toggle">
            <label>Observation Class</label>
            <div class="toggle-buttons">
              <button type="button" class="toggle-btn positive" id="btnPositive" onclick="setObservationClass('Positive')">
                <i class="fas fa-thumbs-up"></i> Positive
              </button>
              <button type="button" class="toggle-btn negative active" id="btnNegative" onclick="setObservationClass('Negative')">
                <i class="fas fa-thumbs-down"></i> Negative
              </button>
            </div>
            <input type="hidden" id="obsClass" value="Negative"/>
          </div>
          <select id="obsActivityType">
            <option value="">-- Activity Type --</option>
            <option value="Welding">Welding</option>
            <option value="Grinding">Grinding</option>
            <option value="Lifting">Lifting</option>
            <option value="Scaffolding">Scaffolding</option>
            <option value="Excavation">Excavation</option>
            <option value="Electrical">Electrical</option>
            <option value="Confined Space">Confined Space</option>
            <option value="Working at Height">Working at Height</option>
            <option value="Hot Work">Hot Work</option>
            <option value="Material Handling">Material Handling</option>
            <option value="Housekeeping">Housekeeping</option>
            <option value="PPE Usage">PPE Usage</option>
            <option value="Vehicle/Equipment">Vehicle/Equipment</option>
            <option value="General">General</option>
          </select>
          <select id="obsType">
            <option value="">-- Observation Type --</option>
            <option value="Unsafe Act">Unsafe Act</option>
            <option value="Unsafe Condition">Unsafe Condition</option>
            <option value="Near Miss">Near Miss</option>
            <option value="Good Practice">Good Practice</option>
            <option value="Housekeeping">Housekeeping</option>
            <option value="PPE Compliance">PPE Compliance</option>
            <option value="Environmental">Environmental</option>
            <option value="Fire Safety">Fire Safety</option>
          </select>
          <textarea id="obsDescription" placeholder="Description of observation" rows="3" required></textarea>
          <input type="text" id="obsDirectCause" placeholder="Direct Cause"/>
          <input type="text" id="obsRootCause" placeholder="Root Cause"/>
          <textarea id="obsImmediateAction" placeholder="Immediate Action Taken" rows="2"></textarea>
          <textarea id="obsCorrectiveAction" placeholder="Corrective Action Required" rows="2"></textarea>
          <select id="obsRiskLevel">
            <option value="Low">Low Risk</option>
            <option value="Medium" selected>Medium Risk</option>
            <option value="High">High Risk</option>
          </select>
          <div class="injury-section" id="injurySection" style="display:none;">
            <label class="section-label"><i class="fas fa-first-aid"></i> Injury Details (if applicable)</label>
            <select id="obsInjuryType">
              <option value="">-- Injury Type --</option>
              <option value="Cut/Laceration">Cut/Laceration</option>
              <option value="Burn">Burn</option>
              <option value="Fracture">Fracture</option>
              <option value="Sprain/Strain">Sprain/Strain</option>
              <option value="Bruise/Contusion">Bruise/Contusion</option>
              <option value="Eye Injury">Eye Injury</option>
              <option value="Hearing Damage">Hearing Damage</option>
              <option value="Respiratory">Respiratory</option>
              <option value="Heat Stress">Heat Stress</option>
              <option value="Other">Other</option>
            </select>
            <select id="obsInjuryBodyPart">
              <option value="">-- Body Part Affected --</option>
              <option value="Head">Head</option>
              <option value="Eyes">Eyes</option>
              <option value="Face">Face</option>
              <option value="Neck">Neck</option>
              <option value="Shoulder">Shoulder</option>
              <option value="Arm">Arm</option>
              <option value="Hand">Hand</option>
              <option value="Fingers">Fingers</option>
              <option value="Chest">Chest</option>
              <option value="Back">Back</option>
              <option value="Abdomen">Abdomen</option>
              <option value="Leg">Leg</option>
              <option value="Knee">Knee</option>
              <option value="Foot">Foot</option>
              <option value="Toes">Toes</option>
              <option value="Multiple">Multiple Body Parts</option>
            </select>
          </div>
          <div class="file-upload-area">
            <label><i class="fas fa-camera"></i> Evidence Photos</label>
            <input type="file" id="obsPhotos" accept="image/*" multiple/>
          </div>
          <button type="submit" class="submit-btn"><i class="fas fa-plus-circle"></i> Add Observation (+10 pts)</button>
        </form>
      </div>
    </div>

    <div class="modal" id="closeObservationModal">
      <div class="modal-content form-modal">
        <button class="close-btn" onclick="closeModal('closeObservationModal')">×</button>
        <h2><i class="fas fa-check-circle"></i> Close Observation</h2>
        <form id="closeObservationForm">
          <input type="hidden" id="closeObsId"/>
          <textarea id="closeObsNotes" placeholder="Closure notes - what was done to resolve this?" rows="4" required></textarea>
          <div class="file-upload-area">
            <label><i class="fas fa-camera"></i> Closure Evidence Photos</label>
            <input type="file" id="closeObsPhotos" accept="image/*" multiple/>
          </div>
          <button type="submit" class="submit-btn"><i class="fas fa-check"></i> Close Observation (+5 pts)</button>
        </form>
      </div>
    </div>

    <div class="modal" id="addPermitModal">
      <div class="modal-content form-modal">
        <button class="close-btn" onclick="closeModal('addPermitModal')">×</button>
        <h2><i class="fas fa-clipboard-check"></i> Add Permit</h2>
        <form id="addPermitForm">
          <input type="date" id="permitDate" required/>
          <input type="text" id="permitArea" placeholder="Area" required/>
          <select id="permitType">
            <option value="">-- Permit Type --</option>
            <option value="Hot Work">Hot Work</option>
            <option value="Confined Space">Confined Space</option>
            <option value="Excavation">Excavation</option>
            <option value="Working at Height">Working at Height</option>
            <option value="Electrical">Electrical</option>
            <option value="General">General Work Permit</option>
          </select>
          <input type="text" id="permitNumber" placeholder="Permit Number"/>
          <input type="text" id="permitProject" placeholder="Project"/>
          <input type="text" id="permitReceiver" placeholder="Permit Receiver"/>
          <input type="text" id="permitIssuer" placeholder="Permit Issuer"/>
          <textarea id="permitDescription" placeholder="Work Description" rows="3"></textarea>
          <button type="submit" class="submit-btn"><i class="fas fa-plus-circle"></i> Add Permit (+8 pts)</button>
        </form>
      </div>
    </div>

    <div class="modal" id="addEquipmentModal">
      <div class="modal-content form-modal">
        <button class="close-btn" onclick="closeModal('addEquipmentModal')">×</button>
        <h2><i class="fas fa-truck"></i> Add Equipment</h2>
        <form id="addEquipmentForm">
          <input type="text" id="eqAssetNumber" placeholder="Asset Number" required/>
          <input type="text" id="eqType" placeholder="Equipment Type" required/>
          <input type="text" id="eqOwner" placeholder="Owner/Company"/>
          <input type="text" id="eqYardArea" placeholder="Yard/Area"/>
          <select id="eqStatus">
            <option value="In Service">In Service</option>
            <option value="Out of Service">Out of Service</option>
          </select>
          <select id="eqPwas">
            <option value="">PWAS Required?</option>
            <option value="Yes">PWAS Needed</option>
            <option value="No">PWAS Not Needed</option>
          </select>
          <div class="form-row">
            <div><label>TPS Date</label><input type="date" id="eqTpsDate"/></div>
            <div><label>TPS Expiry</label><input type="date" id="eqTpsExpiry"/></div>
          </div>
          <div class="form-row">
            <div><label>INS Date</label><input type="date" id="eqInsDate"/></div>
            <div><label>INS Expiry</label><input type="date" id="eqInsExpiry"/></div>
          </div>
          <input type="text" id="eqOperator" placeholder="Operator Name"/>
          <input type="text" id="eqLicense" placeholder="Operator License"/>
          <textarea id="eqNotes" placeholder="Notes" rows="2"></textarea>
          <button type="submit" class="submit-btn"><i class="fas fa-plus-circle"></i> Add Equipment</button>
        </form>
      </div>
    </div>

    <div class="modal" id="addTbtModal">
      <div class="modal-content form-modal">
        <button class="close-btn" onclick="closeModal('addTbtModal')">×</button>
        <h2><i class="fas fa-chalkboard-teacher"></i> Add Toolbox Talk</h2>
        <form id="addTbtForm">
          <input type="date" id="tbtDate" required/>
          <input type="text" id="tbtTopic" placeholder="Topic" required/>
          <input type="text" id="tbtPresenter" placeholder="Presenter"/>
          <input type="text" id="tbtArea" placeholder="Area"/>
          <input type="number" id="tbtAttendance" placeholder="Number of Attendees" min="0"/>
          <textarea id="tbtDescription" placeholder="Description/Notes" rows="3"></textarea>
          <div class="file-upload-area">
            <label><i class="fas fa-camera"></i> Evidence Photos</label>
            <input type="file" id="tbtPhotos" accept="image/*" multiple/>
          </div>
          <button type="submit" class="submit-btn"><i class="fas fa-plus-circle"></i> Add TBT (+12 pts)</button>
        </form>
      </div>
    </div>

    <div class="modal" id="addNewsModal">
      <div class="modal-content form-modal">
        <button class="close-btn" onclick="closeModal('addNewsModal')">×</button>
        <h2><i class="fas fa-bullhorn"></i> Post News (Admin)</h2>
        <form id="addNewsForm">
          <input type="text" id="newsTitle" placeholder="Title" required/>
          <textarea id="newsContent" placeholder="Content" rows="4" required></textarea>
          <select id="newsPriority">
            <option value="normal">Normal</option>
            <option value="important">Important</option>
            <option value="urgent">Urgent</option>
          </select>
          <button type="submit" class="submit-btn"><i class="fas fa-paper-plane"></i> Post News</button>
        </form>
      </div>
    </div>

    <div class="modal" id="addChallengeModal">
      <div class="modal-content form-modal">
        <button class="close-btn" onclick="closeModal('addChallengeModal')">×</button>
        <h2><i class="fas fa-tasks"></i> Add Challenge (Admin)</h2>
        <form id="addChallengeForm">
          <input type="text" id="challengeTitle" placeholder="Challenge Title" required/>
          <textarea id="challengeDescription" placeholder="Description" rows="3"></textarea>
          <input type="number" id="challengePoints" placeholder="Points (default: 10)" min="1" value="10"/>
          <select id="challengeBadgeReward">
            <option value="">-- No Badge Reward --</option>
            <option value="Safety Champion">Safety Champion</option>
            <option value="Observer Pro">Observer Pro</option>
            <option value="First Aider">First Aider</option>
            <option value="Team Leader">Team Leader</option>
            <option value="Risk Buster">Risk Buster</option>
            <option value="PPE Expert">PPE Expert</option>
            <option value="Fire Warden">Fire Warden</option>
            <option value="Challenge Master">Challenge Master</option>
          </select>
          <input type="date" id="challengeDate" placeholder="Challenge Date (leave empty for any day)"/>
          <button type="submit" class="submit-btn"><i class="fas fa-plus-circle"></i> Create Challenge</button>
        </form>
      </div>
    </div>

    <div class="modal" id="viewDetailsModal">
      <div class="modal-content view-details-modal">
        <div class="view-details-header">
          <button class="close-btn" onclick="closeModal('viewDetailsModal')">×</button>
          <h2 id="viewDetailsTitle"><i class="fas fa-eye"></i> Details</h2>
          <button class="print-btn" onclick="printDetails()" title="Print/Download PDF">
            <i class="fas fa-print"></i> Print
          </button>
        </div>
        <div id="viewDetailsContent" class="view-details-body">
          Loading...
        </div>
      </div>
    </div>

    <main class="content-area">
      <section class="tab-content active" id="HomeTab">
        <div class="home-kpi-row">
          <div class="home-kpi-card kpi-green">
            <div class="home-kpi-label">Observations Today</div>
            <div class="home-kpi-value" id="homeObsToday">--</div>
          </div>
          <div class="home-kpi-card kpi-blue">
            <div class="home-kpi-label">Permits Today</div>
            <div class="home-kpi-value" id="homePermitsToday">--</div>
          </div>
          <div class="home-kpi-card kpi-orange">
            <div class="home-kpi-label">TBT Today</div>
            <div class="home-kpi-value" id="homeTbtToday">--</div>
          </div>
        </div>

        <p class="month-color-line">
          <span class="month-color-label">Color Code This Month:</span>
          <span id="colorName" class="month-color-badge">...</span>
        </p>

        <section class="home-card weather-card" id="weatherSection">
          <header class="home-card-header">
            <h3><i class="fas fa-sun"></i> Weather & Heat Stress</h3>
            <button class="link-button" onclick="refreshWeather()"><i class="fas fa-sync-alt"></i> Refresh</button>
          </header>
          <div id="weatherContent" class="weather-content">
            <div class="weather-loading"><i class="fas fa-spinner fa-spin"></i> Getting weather data...</div>
          </div>
        </section>

        <section class="home-card" id="homeTbtSection">
          <header class="home-card-header">
            <h3><i class="fas fa-book-open"></i> TBT of The Day</h3>
          </header>
          <div id="homeTbtContent">Loading...</div>
        </section>

        <section class="home-card highlight-card">
          <header class="home-card-header">
            <h3><i class="fas fa-award"></i> Employee of the Month</h3>
          </header>
          <div id="employeeOfMonth">Loading...</div>
        </section>

        <section class="home-card">
          <header class="home-card-header">
            <h3><i class="fas fa-trophy"></i> Top Safety Performers</h3>
            <button class="link-button" onclick="openModal('leaderboardModal')">Full leaderboard</button>
          </header>
          <div id="homeLeaderboardMini">Loading...</div>
        </section>

        <section class="home-card">
          <header class="home-card-header">
            <h3><i class="fas fa-chart-pie"></i> Top 5 Areas by Observations</h3>
          </header>
          <div class="areas-chart-container">
            <canvas id="areasChart"></canvas>
          </div>
          <div id="areasChartNoData" class="chart-no-data" style="display:none;">No observation data available</div>
        </section>

        <button class="accordion accordion-modal" onclick="openModal('leaderboardModal')">
          <i class="fas fa-trophy"></i> Monthly Leaderboard
        </button>
        <button class="accordion accordion-modal" onclick="openModal('emergencyContactsModal')">
          <i class="fas fa-ambulance"></i> Emergency Contacts
        </button>
        <button class="accordion">
          <i class="fas fa-exclamation-triangle"></i> EMERGENCY REPORTING
        </button>
        <div class="panel">
          <ol>
            <li>Dial the emergency number.</li>
            <li>Describe the exact location.</li>
            <li>Describe the nature of emergency.</li>
            <li>Identify the required service.</li>
            <li>Answer all operator questions.</li>
            <li>Do not hang up until instructed.</li>
          </ol>
          <button class="gps-btn" onclick="getGPSLocation()"><i class="fas fa-map-marker-alt"></i> Share My Location</button>
          <div class="gps-result" id="locationResult"></div>
        </div>
        <button class="accordion">
          <i class="fas fa-user-shield"></i> Safety Responsibilities
        </button>
        <div class="panel">
          <ol>
            <li>Follow site HSE reporting chain to Supervisor, Coordinator & Manager.</li>
            <li>Demonstrate the priority of safety in all activities with good personal example.</li>
            <li>Understand safety requirements: CSSP, HIP, JSA, GI's, CSM, local laws.</li>
            <li>Conduct all TBTs (Daily, Weekly & Mass) with workers and supervisors.</li>
            <li>Conduct frequent HSE inspections and continuous monitoring.</li>
            <li>Report all NM, FAI, CA & PA to HSE supervisor.</li>
            <li>Report all incidents resulting in injury or property damage.</li>
            <li>Stop work as per HSI 063 and Area Manager Stop Work Authority Policy.</li>
            <li>Ensure 100% work permit system compliance at site.</li>
            <li>Ensure scaffolding, ladders are safe, inspected & tagged before use.</li>
          </ol>
        </div>
        <button class="accordion">
          <i class="fas fa-link"></i> Useful Links
        </button>
        <div class="panel">
          <ul class="links-list">
            <li><a href="https://drive.google.com/file/d/1JS1VQKXLHdOOFXpYcpRftM-kviBv-TYd/view" target="_blank">CSM Book</a></li>
            <li><a href="https://drive.google.com/file/d/109vG3Hk3PdgvQF87k0EJ1IiKDTDfdQTv/view" target="_blank">Saudi Aramco Safety Handbook</a></li>
          </ul>
        </div>
        <button class="accordion">
          <i class="fas fa-info-circle"></i> About
        </button>
        <div class="panel">
          <p>Developed by <strong>Abdulrahman Alanazi [8222802]</strong> under supervision of <strong>Abdullah Alkaluf [8230855]</strong></p>
          <p>Contact: Catproject404@gmail.com</p>
        </div>
      </section>

      <section class="tab-content" id="ObservationsTab">
        <div class="obs-summary-bar">
          <div class="obs-summary-item summary-purple">
            <div class="obs-summary-label" id="obsSummaryLabel">This Month</div>
            <div class="obs-summary-value" id="obsCountTotal">--</div>
          </div>
          <div class="obs-summary-item summary-green">
            <div class="obs-summary-label">Open</div>
            <div class="obs-summary-value" id="obsCountOpen">--</div>
          </div>
          <div class="obs-summary-item summary-red">
            <div class="obs-summary-label">Closed</div>
            <div class="obs-summary-value" id="obsCountClosed">--</div>
          </div>
        </div>
        <div class="obs-filters">
          <div class="obs-filter-row">
            <button class="obs-filter-chip" data-range="today">Today</button>
            <button class="obs-filter-chip" data-range="week">This Week</button>
            <button class="obs-filter-chip active" data-range="month">This Month</button>
            <button class="obs-filter-chip" data-range="all">All</button>
          </div>
          <div class="obs-filter-row">
            <select id="obsFilterArea"><option value="">All Areas</option></select>
            <select id="obsFilterStatus">
              <option value="">All Statuses</option>
              <option value="Open">Open</option>
              <option value="Closed">Closed</option>
            </select>
          </div>
          <div class="obs-filter-row">
            <input type="text" id="obsSearch" placeholder="Search observations..."/>
          </div>
          <div class="obs-filter-row" style="justify-content:center;">
            <button class="obs-open-sheet-btn" onclick="openModal('addObservationModal')">
              <i class="fas fa-plus-circle"></i> Add Observation
            </button>
          </div>
        </div>
        <div id="observationsList"></div>
      </section>

      <section class="tab-content" id="PermitsTab">
        <div class="obs-summary-bar">
          <div class="obs-summary-item summary-purple">
            <div class="obs-summary-label">Total Permits</div>
            <div class="obs-summary-value" id="permitsCountTotal">--</div>
          </div>
          <div class="obs-summary-item summary-blue">
            <div class="obs-summary-label">Areas Covered</div>
            <div class="obs-summary-value" id="permitsCountAreas">--</div>
          </div>
          <div class="obs-summary-item summary-green">
            <div class="obs-summary-label" id="permitsSummaryLabel">Today</div>
            <div class="obs-summary-value" id="permitsCountToday">--</div>
          </div>
        </div>
        <div class="obs-filters">
          <div class="obs-filter-row">
            <button class="obs-filter-chip permits-chip active" data-range="today">Today</button>
            <button class="obs-filter-chip permits-chip" data-range="week">This Week</button>
            <button class="obs-filter-chip permits-chip" data-range="month">This Month</button>
            <button class="obs-filter-chip permits-chip" data-range="all">All</button>
          </div>
          <div class="obs-filter-row">
            <select id="permitsFilterArea"><option value="">All Areas</option></select>
            <select id="permitsFilterType"><option value="">All Types</option></select>
          </div>
          <div class="obs-filter-row">
            <input type="text" id="permitsSearch" placeholder="Search permits..."/>
          </div>
          <div class="obs-filter-row" style="justify-content:center;">
            <button class="obs-open-sheet-btn" onclick="openModal('addPermitModal')">
              <i class="fas fa-plus-circle"></i> Add Permit
            </button>
          </div>
        </div>
        <div id="permitsList"></div>
      </section>

      <section class="tab-content" id="EquipmentTab">
        <div class="obs-summary-bar">
          <div class="obs-summary-item summary-purple">
            <div class="obs-summary-label">Total Equipment</div>
            <div class="obs-summary-value" id="eqCountTotal">--</div>
          </div>
          <div class="obs-summary-item summary-orange">
            <div class="obs-summary-label">TPS Expiring</div>
            <div class="obs-summary-value" id="eqCountTps">--</div>
          </div>
          <div class="obs-summary-item summary-red">
            <div class="obs-summary-label">INS Expiring</div>
            <div class="obs-summary-value" id="eqCountIns">--</div>
          </div>
        </div>
        <div class="obs-filters">
          <div class="obs-filter-row">
            <select id="eqFilterArea"><option value="">All Areas</option></select>
            <select id="eqFilterStatus">
              <option value="">All Statuses</option>
              <option value="In Service">In Service</option>
              <option value="Out of Service">Out of Service</option>
            </select>
          </div>
          <div class="obs-filter-row">
            <input type="text" id="eqSearch" placeholder="Search equipment..."/>
          </div>
          <div class="obs-filter-row" style="justify-content:center;">
            <button class="obs-open-sheet-btn" onclick="openModal('addEquipmentModal')">
              <i class="fas fa-plus-circle"></i> Add Equipment
            </button>
          </div>
        </div>
        <div id="equipmentList"></div>
      </section>

      <section class="tab-content" id="TbtTab">
        <div class="obs-summary-bar">
          <div class="obs-summary-item summary-purple">
            <div class="obs-summary-label">Total TBT</div>
            <div class="obs-summary-value" id="tbtCountTotal">--</div>
          </div>
          <div class="obs-summary-item summary-green">
            <div class="obs-summary-label" id="tbtSummaryLabel">Today</div>
            <div class="obs-summary-value" id="tbtCountFiltered">--</div>
          </div>
          <div class="obs-summary-item summary-blue">
            <div class="obs-summary-label">Avg Attendance</div>
            <div class="obs-summary-value" id="tbtAvgAttendance">--</div>
          </div>
        </div>
        <div class="obs-filters">
          <div class="obs-filter-row">
            <button class="obs-filter-chip tbt-chip active" data-range="today">Today</button>
            <button class="obs-filter-chip tbt-chip" data-range="week">This Week</button>
            <button class="obs-filter-chip tbt-chip" data-range="month">This Month</button>
            <button class="obs-filter-chip tbt-chip" data-range="all">All</button>
          </div>
          <div class="obs-filter-row">
            <input type="text" id="tbtSearch" placeholder="Search TBT..."/>
          </div>
          <div class="obs-filter-row" style="justify-content:center;">
            <button class="obs-open-sheet-btn" onclick="openModal('addTbtModal')">
              <i class="fas fa-plus-circle"></i> Add Toolbox Talk
            </button>
          </div>
        </div>
        <div id="tbtList"></div>
      </section>

      <section class="tab-content" id="LibraryTab">
        <h2><i class="fas fa-book"></i> Safety Library</h2>
        <div class="library-grid">
          <div class="library-card" onclick="openLibrarySection('tbt')">
            <i class="fas fa-chalkboard-teacher"></i>
            <h3>TBT Library</h3>
            <p>Toolbox Talk documents</p>
          </div>
          <div class="library-card" onclick="openLibrarySection('jsa')">
            <i class="fas fa-clipboard-list"></i>
            <h3>JSA Library</h3>
            <p>Job Safety Analysis</p>
          </div>
          <div class="library-card" onclick="openLibrarySection('csm')">
            <i class="fas fa-hard-hat"></i>
            <h3>CSM Library</h3>
            <p>Construction Safety Manual</p>
          </div>
          <div class="library-card" onclick="window.open('https://drive.google.com/file/d/109vG3Hk3PdgvQF87k0EJ1IiKDTDfdQTv/view','_blank')">
            <i class="fas fa-book-open"></i>
            <h3>Safety Handbook</h3>
            <p>Saudi Aramco Safety Handbook</p>
          </div>
        </div>
        <div id="libraryContent" style="display:none;">
          <button class="back-btn" onclick="closeLibrarySection()"><i class="fas fa-arrow-left"></i> Back</button>
          <input type="text" id="librarySearch" placeholder="Search documents..."/>
          <div id="libraryList"></div>
        </div>
      </section>

      <section class="tab-content" id="ToolsTab">
        <h2><i class="fas fa-tools"></i> Safety Tools</h2>
        <div class="tools-grid">
          <div class="tool-card" onclick="toggleToolSection('trainingMatrix')">
            <i class="fas fa-graduation-cap"></i>
            <span>Training Matrix</span>
          </div>
          <div class="tool-card" onclick="toggleToolSection('heatStress')">
            <i class="fas fa-thermometer-half"></i>
            <span>Heat Stress</span>
          </div>
          <div class="tool-card" onclick="toggleToolSection('windSpeed')">
            <i class="fas fa-wind"></i>
            <span>Wind Speed</span>
          </div>
          <div class="tool-card" onclick="toggleToolSection('riskMatrix')">
            <i class="fas fa-th"></i>
            <span>Risk Matrix</span>
          </div>
          <div class="tool-card" onclick="toggleToolSection('lifeSaving')">
            <i class="fas fa-heart"></i>
            <span>Life Saving Rules</span>
          </div>
          <div class="tool-card" onclick="toggleToolSection('challenges')">
            <i class="fas fa-tasks"></i>
            <span>Daily Challenges</span>
          </div>
        </div>

        <div id="trainingMatrixSection" class="tool-section" style="display:none;">
          <h3><i class="fas fa-graduation-cap"></i> Training Matrix</h3>
          <div class="training-matrix">
            <table>
              <thead><tr><th>Training</th><th>Frequency</th><th>Target</th></tr></thead>
              <tbody>
                <tr><td>HSE Induction</td><td>Once</td><td>All Workers</td></tr>
                <tr><td>Toolbox Talks</td><td>Daily</td><td>All Workers</td></tr>
                <tr><td>Fire Safety</td><td>Annual</td><td>All Workers</td></tr>
                <tr><td>First Aid/CPR</td><td>Bi-Annual</td><td>First Aiders</td></tr>
                <tr><td>Confined Space</td><td>Annual</td><td>Authorized Entrants</td></tr>
                <tr><td>Working at Height</td><td>Annual</td><td>WAH Workers</td></tr>
                <tr><td>Rigging & Lifting</td><td>Annual</td><td>Riggers</td></tr>
                <tr><td>Scaffold Competency</td><td>Annual</td><td>Scaffolders</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="heatStressSection" class="tool-section" style="display:none;">
          <h3><i class="fas fa-thermometer-half"></i> Heat Stress Calculator</h3>
          <div class="calculator-form">
            <label>Temperature (°C)</label>
            <input type="number" id="inputTemp" placeholder="e.g., 35" oninput="calculateHeatIndex()"/>
            <label>Humidity (%)</label>
            <input type="number" id="inputHumidity" placeholder="e.g., 40" oninput="calculateHeatIndex()"/>
            <div class="result-card">
              <div class="result-label">Heat Index</div>
              <div class="result-value" id="heatIndexResult">--</div>
              <div class="result-status" id="heatRiskLevel">Enter values above</div>
            </div>
          </div>
        </div>

        <div id="windSpeedSection" class="tool-section" style="display:none;">
          <h3><i class="fas fa-wind"></i> Wind Speed Safety</h3>
          <div class="calculator-form">
            <label>Wind Speed (km/h)</label>
            <input type="number" id="inputWind" placeholder="e.g., 25" oninput="calculateWindSafety()"/>
            <div class="result-card">
              <div class="result-label">Safety Status</div>
              <div class="result-value" id="windResult">--</div>
              <div class="result-status" id="windRestrictions">Enter wind speed</div>
            </div>
          </div>
          <div class="wind-limits">
            <h4>Work Restrictions by Wind Speed:</h4>
            <ul>
              <li><strong>&lt;25 km/h:</strong> Normal operations</li>
              <li><strong>25-40 km/h:</strong> Caution - secure loose materials</li>
              <li><strong>40-55 km/h:</strong> Stop crane operations, WAH review</li>
              <li><strong>&gt;55 km/h:</strong> Stop all outdoor work</li>
            </ul>
          </div>
        </div>

        <div id="riskMatrixSection" class="tool-section" style="display:none;">
          <h3><i class="fas fa-th"></i> Risk Assessment Matrix</h3>
          <div class="risk-matrix">
            <table>
              <thead>
                <tr><th></th><th>Insignificant</th><th>Minor</th><th>Moderate</th><th>Major</th><th>Catastrophic</th></tr>
              </thead>
              <tbody>
                <tr><td><strong>Almost Certain</strong></td><td class="risk-medium">M</td><td class="risk-high">H</td><td class="risk-high">H</td><td class="risk-extreme">E</td><td class="risk-extreme">E</td></tr>
                <tr><td><strong>Likely</strong></td><td class="risk-medium">M</td><td class="risk-medium">M</td><td class="risk-high">H</td><td class="risk-high">H</td><td class="risk-extreme">E</td></tr>
                <tr><td><strong>Possible</strong></td><td class="risk-low">L</td><td class="risk-medium">M</td><td class="risk-medium">M</td><td class="risk-high">H</td><td class="risk-high">H</td></tr>
                <tr><td><strong>Unlikely</strong></td><td class="risk-low">L</td><td class="risk-low">L</td><td class="risk-medium">M</td><td class="risk-medium">M</td><td class="risk-high">H</td></tr>
                <tr><td><strong>Rare</strong></td><td class="risk-low">L</td><td class="risk-low">L</td><td class="risk-low">L</td><td class="risk-medium">M</td><td class="risk-medium">M</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="lifeSavingSection" class="tool-section" style="display:none;">
          <h3><i class="fas fa-heart"></i> Life Saving Rules</h3>
          <div class="life-saving-rules">
            <div class="rule-item"><i class="fas fa-check-circle"></i> Work with valid permit when required</div>
            <div class="rule-item"><i class="fas fa-check-circle"></i> Conduct gas tests when required</div>
            <div class="rule-item"><i class="fas fa-check-circle"></i> Verify isolation before work</div>
            <div class="rule-item"><i class="fas fa-check-circle"></i> Obtain authorization before entering confined space</div>
            <div class="rule-item"><i class="fas fa-check-circle"></i> Protect yourself against falls when working at height</div>
            <div class="rule-item"><i class="fas fa-check-circle"></i> Do not walk under suspended load</div>
            <div class="rule-item"><i class="fas fa-check-circle"></i> Do not smoke outside designated areas</div>
            <div class="rule-item"><i class="fas fa-check-circle"></i> No alcohol or drugs while working</div>
            <div class="rule-item"><i class="fas fa-check-circle"></i> While driving, do not use phone and wear seatbelt</div>
            <div class="rule-item"><i class="fas fa-check-circle"></i> Follow prescribed journey management plan</div>
          </div>
        </div>

        <div id="challengesSection" class="tool-section" style="display:none;">
          <h3><i class="fas fa-tasks"></i> Daily Challenges</h3>
          <p class="challenges-intro">Complete challenges to earn points! Upload photo evidence.</p>
          <div id="challengesList">Loading challenges...</div>
        </div>
      </section>

      <section class="tab-content" id="SettingsTab">
        <h2><i class="fas fa-cog"></i> Settings</h2>
        
        <div class="settings-profile-section">
          <div class="settings-profile-card">
            <div class="profile-picture-container">
              <img id="settingsProfilePic" src="img/default-avatar.svg" alt="Profile" class="profile-picture"/>
              <label for="profilePicInput" class="profile-picture-edit">
                <i class="fas fa-camera"></i>
              </label>
              <input type="file" id="profilePicInput" accept="image/*" style="display:none;" onchange="uploadProfilePicture(this)"/>
            </div>
            <div class="profile-info">
              <div class="profile-name" id="settingsUserName">User Name</div>
              <div class="profile-id" id="settingsEmployeeId">Employee ID</div>
              <div class="profile-role" id="settingsUserRole">Role</div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3><i class="fas fa-medal"></i> Your Badges</h3>
          <div id="settingsBadges" class="badges-container">
            <div class="no-badges">No badges earned yet. Keep up the good work!</div>
          </div>
        </div>

        <div class="settings-section">
          <h3><i class="fas fa-star"></i> Points & Level</h3>
          <div class="points-level-card">
            <div class="points-info">
              <div class="points-value" id="settingsPoints">0</div>
              <div class="points-label">Total Points</div>
            </div>
            <div class="level-info">
              <div class="level-value" id="settingsLevel">1</div>
              <div class="level-label">Current Level</div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3><i class="fas fa-palette"></i> Appearance</h3>
          <div class="settings-option" onclick="toggleDarkModeSettings()">
            <div class="settings-option-info">
              <i class="fas fa-moon settings-option-icon"></i>
              <span>Dark Mode</span>
            </div>
            <div class="settings-toggle" id="darkModeToggle">
              <div class="toggle-slider"></div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3><i class="fas fa-sign-out-alt"></i> Account</h3>
          <button class="settings-logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </section>

      <section class="tab-content" id="AdminTab">
        <h2><i class="fas fa-user-shield"></i> Admin Panel</h2>
        <div class="admin-grid">
          <div class="admin-card" onclick="loadPendingUsers()">
            <i class="fas fa-user-clock"></i>
            <span>Pending Approvals</span>
            <span id="pendingCount" class="pending-badge" style="display:none;">0</span>
          </div>
          <div class="admin-card" onclick="openModal('addNewsModal')">
            <i class="fas fa-bullhorn"></i>
            <span>Post News</span>
          </div>
          <div class="admin-card" onclick="loadAdminUsers()">
            <i class="fas fa-users"></i>
            <span>Manage Users</span>
          </div>
          <div class="admin-card" onclick="loadAdminChallenges()">
            <i class="fas fa-tasks"></i>
            <span>Manage Challenges</span>
          </div>
          <div class="admin-card" onclick="importHistoricalObservations()">
            <i class="fas fa-file-import"></i>
            <span>Import Historical Data</span>
          </div>
        </div>
        <div id="adminContent"></div>
      </section>
    </main>

    <nav class="nav-bar">
      <button class="nav-button active" data-tab="HomeTab">
        <i class="fas fa-home nav-icon"></i>
        <span>Home</span>
      </button>
      <button class="nav-button" data-tab="ObservationsTab">
        <i class="fas fa-eye nav-icon"></i>
        <span>Observe</span>
      </button>
      <button class="nav-button" data-tab="PermitsTab">
        <i class="fas fa-clipboard-check nav-icon"></i>
        <span>Permits</span>
      </button>
      <button class="nav-button" data-tab="EquipmentTab">
        <i class="fas fa-truck nav-icon"></i>
        <span>Equipment</span>
      </button>
      <button class="nav-button" data-tab="MoreTab" onclick="toggleMoreMenu(event)">
        <i class="fas fa-ellipsis-h nav-icon"></i>
        <span>More</span>
      </button>
    </nav>

    <div class="more-menu" id="moreMenu" style="display:none;">
      <button onclick="openTab(null,'TbtTab');hideMoreMenu()"><i class="fas fa-chalkboard-teacher"></i> Toolbox Talks</button>
      <button onclick="openTab(null,'LibraryTab');hideMoreMenu()"><i class="fas fa-book"></i> Library</button>
      <button onclick="openTab(null,'ToolsTab');hideMoreMenu()"><i class="fas fa-tools"></i> Tools</button>
      <button onclick="openTab(null,'SettingsTab');loadSettingsData();hideMoreMenu()"><i class="fas fa-cog"></i> Settings</button>
      <button id="adminMenuBtn" style="display:none;" onclick="openTab(null,'AdminTab');hideMoreMenu()"><i class="fas fa-user-shield"></i> Admin</button>
    </div>
  </div>
  <script src="js/app.js"></script>
</body>
</html>
